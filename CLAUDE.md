# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What This Is

This is the **@img-src/sdk** TypeScript SDK — an auto-generated client library for the img-src image processing API. All source code under `src/` is **generated by [Speakeasy](https://speakeasy.com)** from the OpenAPI spec at `api/openapi.json` in the parent repository. Every source file has a `/* Code generated by Speakeasy ... DO NOT EDIT. */` header.

**Do not manually edit files under `src/`.** Changes will be overwritten on the next Speakeasy regeneration. To change SDK behavior, modify the OpenAPI spec and regenerate.

## Commands

```bash
npm install          # Install dependencies
npm run build        # Build via tshy (outputs ESM + CommonJS to dist/)
npm run lint         # ESLint with zero warnings allowed
npm test             # Run tests (CI runs this across Node 20, 22, 24)
```

There is no `npm run dev` or watch mode — this is a library, not an application.

### CI Checks (what PR builds run)

```bash
npm run build && npm test
```

CI matrix: Node.js 20, 22, 24 on ubuntu-latest.

## Architecture

### Build System

- **tshy** produces dual ESM (`dist/esm/`) and CommonJS (`dist/commonjs/`) output
- Package exports are defined in both `package.json` (runtime) and `tshy.exports` (source)
- Only production dependency: `zod` (v3 or v4)

### SDK Structure

```
src/
├── index.ts              # Main export (Imgsrc class, HTTPClient, config)
├── core.ts               # ImgsrcCore — lightweight client for standalone functions
├── sdk/
│   ├── sdk.ts            # Imgsrc class (extends ClientSDK, has .images, .presets, .settings, .usage)
│   ├── images.ts         # Images resource (upload, list, search, get, delete, signedUrl)
│   ├── presets.ts        # Presets resource (CRUD)
│   ├── settings.ts       # Settings resource (get, update)
│   └── usage.ts          # Usage resource (getUsage)
├── funcs/                # 16 standalone functions (tree-shakeable, return Result<T,E>)
├── models/
│   ├── components/       # 37 data model types (Zod schemas + TypeScript types)
│   ├── operations/       # 15 request/response operation types
│   └── errors/           # Error classes (ImgsrcError base, ErrorResponse, network errors)
├── lib/
│   ├── config.ts         # SDK configuration, server URLs, option types
│   ├── sdks.ts           # ClientSDK base class
│   ├── http.ts           # HTTPClient with fetch wrapper and hook system
│   ├── security.ts       # Bearer token auth resolution
│   ├── retries.ts        # Retry/backoff logic
│   ├── encodings.ts      # Query/form parameter encoding
│   ├── matchers.ts       # Response status code matching
│   ├── schemas.ts        # Zod schema parsing helpers
│   └── ...               # url, files, base64, logger, primitives
├── hooks/                # Request lifecycle hooks (sdkInit, beforeRequest, afterSuccess, etc.)
└── types/                # Utility types (Result<T,E>, PageIterator, RFCDate, enums, file types)
```

### Two API Styles

1. **Class-based** (default): `new Imgsrc({ bearerAuth }).images.uploadImage(...)`
2. **Standalone functions** (tree-shakeable): `imagesUploadImage(core, ...)` returns `Result<T, E>` instead of throwing

### Key Patterns

- All operations validate input/output with Zod schemas
- Auth is bearer token (`bearerAuth` option) — can be a string or `() => Promise<string>`
- Paginated endpoints return async iterables (`for await...of`)
- `HTTPClient` supports hooks (`beforeRequest`, `requestError`, `response`) and custom fetcher injection
- Error hierarchy: `ImgsrcError` → `ErrorResponse` (HTTP errors), plus `ConnectionError`, `RequestTimeoutError`, etc. (network errors)

### ESLint Configuration

Several rules are intentionally disabled because the code is auto-generated:
- `@typescript-eslint/no-unused-vars`, `no-explicit-any`, `no-empty-object-type`, `no-namespace` — all off
- `no-constant-condition`, `no-useless-escape` — off

## Regeneration

The SDK is regenerated from the OpenAPI spec using Speakeasy. Generation metadata lives in `.speakeasy/gen.lock`. The current generation:
- Speakeasy v1.685.3 / Generation v2.795.8
- SDK version: 0.3.0
- OpenAPI doc version: 1.0.0

To regenerate, update the OpenAPI spec and run Speakeasy's generation tooling. See the parent repository's workflow for the exact regeneration command.

## Testing

The SDK uses **Vitest** for testing. Test infrastructure includes:

### Test Categories

- **Component Schema Tests** (`test/components/`): Validate Zod schemas for data model types in `models/components/`
- **Operation Schema Tests** (`test/operations/`): Validate request/response schemas for operation types
- **Integration Tests** (`test/integration/sdk-e2e.test.ts`): E2E tests against the live API (not run in CI)

### Running Tests

```bash
npm test                                    # Run all tests (unit only in CI)
IMGSRC_API_KEY=xxx npm test                 # Run all tests including E2E
npm test -- test/integration/sdk-e2e.test.ts  # Run E2E tests only
```

E2E integration tests require a live API key and are skipped automatically when `IMGSRC_API_KEY` is not set (via `describe.skipIf`). They are not run in CI.

### Test Configuration

- **Config**: `vitest.config.ts` with globals enabled
- **Test Pattern**: `test/**/*.test.ts`
- **CI Matrix**: Node.js 20, 22, 24 on ubuntu-latest

## CD/Publishing

The SDK is published to npm automatically when a git tag is pushed.

### Release Process

```bash
# 1. Update version in package.json
# 2. Commit the version bump
# 3. Tag and push to trigger publish
git tag v0.3.0
git push origin v0.3.0
```

### Publish Workflow (`.github/workflows/publish.yml`)

1. Runs full test suite across Node.js 20, 22, 24
2. Validates git tag matches `package.json` version (fails if mismatch)
3. Publishes to npm with `--provenance` flag (supply chain security)
4. Creates a GitHub Release with auto-generated notes

**Requirements:**
- `NPM_TOKEN` secret in GitHub repository settings
- Tag format: `v*` (e.g., `v0.3.0`)
- Tag version must match `package.json` version exactly

**Permissions:** `contents: write` (GitHub releases), `id-token: write` (npm provenance)

## Supported Runtimes

Node.js 20+, evergreen browsers, Bun 1+, Deno 1.39+. Requires Fetch API, Streams API, and async iterables. Consumers should target `es2020` or higher with `lib: ["es2020", "dom", "dom.iterable"]`.
